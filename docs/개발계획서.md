# 영어 자료실 프로젝트 개발 계획서

## 📋 프로젝트 개요
현재 운영 중인 유료사이트의 일부 자료를 무료 공개하여 사용자 피드백을 수집하는 자료실 시스템

---

## 🎯 핵심 목표
- 사용자가 많은 교재 및 단원 수 집계
- 추가 제작 요청 교재 수집
- 시간대별 접속 인원 분석
- 사용자 피드백 수집


## 🔥 핵심 기능 (Critical Features)
### 1. 로컬-드롭박스 실시간 동기화
- **로컬 폴더가 Dropbox와 동기화되어 있음** (Dropbox Desktop App 사용)
- 로컬에서 파일 추가/삭제/수정 시 → Dropbox 자동 동기화
- Dropbox API로 변화 감지 및 자동 반영
- **PDF 파일만 필터링하여 표시** (.pdf 확장자만)

### 2. Dropbox Webhooks 실시간 알림
- Dropbox 폴더 변경 시 즉시 웹훅 수신
- 파일 구조 자동 리프레시
- 데이터베이스 자동 업데이트 (신규/삭제 파일)

---

## 🛠️ 기술 스택
- **Frontend**: Next.js (최신 버전, App Router)
- **UI Library**: shadcn/ui (Vercel 스타일의 전문적 분위기)
- **Database**: Supabase (PostgreSQL)
- **Storage**: Dropbox API
- **Deployment**: Vercel
- **Language**: TypeScript

---

## 📐 시스템 아키텍처

### 메인 페이지 (3단 레이아웃)
```
전체 화면: 1920px 기준

┌─────────┬──────────────────────┬─────────┐
│  좌측    │       중앙 (PDF)      │  우측    │
│  280px  │    1360px (flex-1)   │  280px  │
├─────────┼──────────────────────┼─────────┤
│• 교재 트리│     PDF 뷰어         │•최근 조회│
│ (클릭수) │   [A4: 700-800px]   │•요청순위 │
│• 검색    │    중앙 정렬          │•공지사항 │
│• 정렬    │                      │         │
│• 요청    │                      │         │
└─────────┴──────────────────────┴─────────┘

화면별 비율:
- 1920px: 280px | flex-1 (max-900px) | 280px
- 1366px: 240px | flex-1 (max-800px) | 240px  
- <1024px: Drawer | 100% | Drawer
```

### 관리자 페이지
- 교재 클릭수 통계
- 요청 교재 관리
- 공지사항 관리
- 사용자 행동 분석 대시보드

---

## 📊 데이터베이스 스키마 설계

### 1. textbooks (교재)
```sql
CREATE TABLE textbooks (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name VARCHAR(255) NOT NULL,
  dropbox_path VARCHAR(500) NOT NULL,
  click_count INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

### 2. chapters (단원)
```sql
CREATE TABLE chapters (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  textbook_id UUID REFERENCES textbooks(id) ON DELETE CASCADE,
  name VARCHAR(255) NOT NULL,
  dropbox_path VARCHAR(500) NOT NULL,
  created_at TIMESTAMP DEFAULT NOW()
);
```

### 3. files (PDF 파일)
```sql
CREATE TABLE files (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  chapter_id UUID REFERENCES chapters(id) ON DELETE CASCADE,
  name VARCHAR(255) NOT NULL,
  file_type VARCHAR(100) DEFAULT 'pdf',
  dropbox_path VARCHAR(500) NOT NULL UNIQUE,
  dropbox_file_id VARCHAR(255),           -- Dropbox 파일 고유 ID
  dropbox_rev VARCHAR(255),               -- Dropbox revision (변경 감지용)
  file_size BIGINT,                       -- 파일 크기 (bytes)
  last_modified TIMESTAMP,                -- 마지막 수정 시간
  click_count INTEGER DEFAULT 0,
  is_active BOOLEAN DEFAULT TRUE,         -- 삭제된 파일 비활성화
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- PDF 파일만 체크하는 제약조건
ALTER TABLE files ADD CONSTRAINT check_pdf_only 
  CHECK (file_type = 'pdf' OR name LIKE '%.pdf');
```

### 4. textbook_requests (교재 요청)
```sql
CREATE TABLE textbook_requests (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  textbook_name VARCHAR(255) NOT NULL,
  request_count INTEGER DEFAULT 1,
  user_ip VARCHAR(50),
  created_at TIMESTAMP DEFAULT NOW()
);
```

### 5. notices (공지사항)
```sql
CREATE TABLE notices (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  title VARCHAR(255) NOT NULL,
  content TEXT,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

### 6. user_analytics (사용자 분석)
```sql
CREATE TABLE user_analytics (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_ip VARCHAR(50),
  accessed_at TIMESTAMP DEFAULT NOW(),
  page_view VARCHAR(255),
  session_duration INTEGER
);
```

### 7. file_clicks (파일 클릭 로그)
```sql
CREATE TABLE file_clicks (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  file_id UUID REFERENCES files(id),
  user_ip VARCHAR(50),
  clicked_at TIMESTAMP DEFAULT NOW()
);
```

### 8. dropbox_sync_log (드롭박스 동기화 로그) ⭐ NEW
```sql
CREATE TABLE dropbox_sync_log (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  sync_type VARCHAR(50) NOT NULL,        -- 'add', 'modify', 'delete', 'full_scan'
  dropbox_path VARCHAR(500) NOT NULL,
  file_id UUID REFERENCES files(id),
  status VARCHAR(50) DEFAULT 'pending',   -- 'pending', 'success', 'failed'
  error_message TEXT,
  synced_at TIMESTAMP DEFAULT NOW()
);

-- 인덱스 추가
CREATE INDEX idx_sync_log_status ON dropbox_sync_log(status);
CREATE INDEX idx_sync_log_synced_at ON dropbox_sync_log(synced_at DESC);
```

### 9. dropbox_cursor (드롭박스 변경 감지 커서) ⭐ NEW
```sql
CREATE TABLE dropbox_cursor (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  cursor_value TEXT NOT NULL,             -- Dropbox API 커서
  last_checked TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

---

## 🚀 Phase 1: 기본 셋팅 (1차 개발 목표)

### Task 1: 프로젝트 초기화 ✅ **완료**
**목표**: Next.js 프로젝트 생성 및 기본 구조 설정

**완료 일자**: 2025-11-10

**생성된 구조**:
```
eng-lib/
├── src/app/          # Next.js App Router
├── src/types/        # TypeScript 타입 정의
├── package.json      # 의존성 관리
├── tsconfig.json     # TypeScript 설정
├── tailwind.config.ts # Tailwind 설정
└── README.md         # 프로젝트 문서
```

**설치된 패키지**:
- `next@15.0.3` ✅
- `react@18.3.1`, `react-dom@18.3.1` ✅
- `typescript@5.x` ✅
- `tailwindcss@3.4.15` ✅
- 총 397개 패키지 설치

**완료 조건**:
- ✅ Next.js 프로젝트 생성 (15.0.3)
- ✅ TypeScript 설정 완료
- ✅ Tailwind CSS 설정 완료
- ✅ 기본 타입 정의 (9개 테이블 타입)
- ✅ 환경 변수 템플릿 작성
- ✅ README 작성
- ✅ 개발 서버 실행 확인

**상세 보고서**: [Task1_완료보고서.md](Task1_완료보고서.md)

---

### Task 2: Supabase 설정 ✅ **완료**
**목표**: Supabase 프로젝트 생성 및 클라이언트 연동

**완료 일자**: 2025-11-10

**작업 완료**:
1. ✅ SQL 스키마 작성 (`supabase/schema.sql` - 430줄)
2. ✅ 9개 테이블 정의 (textbooks, chapters, files, requests, notices, analytics, clicks, sync_log, cursor)
3. ✅ RLS 정책 설정 (공개 읽기 + 인증 쓰기 + 관리자 전용)
4. ✅ 트리거 및 함수 (클릭수 자동 증가, updated_at 자동 갱신)
5. ✅ 인덱스 최적화 (20개)
6. ✅ 통계 뷰 (textbook_stats)

**설치된 패키지**:
```bash
npm install @supabase/supabase-js @supabase/ssr
```

**생성된 파일**:
- ✅ `supabase/schema.sql` - SQL 스키마
- ✅ `src/lib/supabase/client.ts` - 클라이언트 설정
- ✅ `src/lib/supabase/server.ts` - 서버 설정 (SSR)
- ✅ `src/lib/supabase/types.ts` - 타입 정의
- ✅ `src/app/test-db/page.tsx` - 연결 테스트 페이지
- ✅ `docs/Supabase_설정_가이드.md` - 상세 가이드

**완료 조건**:
- ✅ SQL 스키마 작성 (9개 테이블)
- ✅ RLS 정책 적용
- ✅ 트리거 및 함수 생성
- ✅ 클라이언트 설정 완료
- ✅ 타입 정의 완료
- ✅ 테스트 페이지 작성
- ✅ 설정 가이드 문서화

**⏳ 사용자 작업 필요**:
1. Supabase 프로젝트 생성
2. `.env.local` 파일 설정
3. SQL 스키마 실행
4. 연결 테스트 (http://localhost:3000/test-db)

**상세 보고서**: [Task2_완료보고서.md](Task2_완료보고서.md)

---

### Task 3: shadcn/ui 설정
**목표**: UI 컴포넌트 라이브러리 설치

**작업 내용**:
```bash
npx shadcn-ui@latest init
```

**필요한 컴포넌트**:
- Button
- Card
- Input
- ScrollArea
- Separator
- Sheet
- Table
- Tabs
- Dialog
- Command (검색용)
- Badge
- Skeleton

**완료 조건**:
- ✅ shadcn/ui 설치
- ✅ 필요한 컴포넌트 추가
- ✅ 테마 설정 (Vercel 스타일)

---

### Task 4: Dropbox API 연동 및 실시간 동기화 ⭐ 핵심
**목표**: Dropbox에서 파일 목록을 가져오고 실시간 변경사항을 감지하는 기능 구현

**작업 내용**:
1. Dropbox App 생성 (dropbox.com/developers)
2. Access Token 발급
3. Dropbox SDK 설치 및 서비스 클래스 작성
4. **Dropbox Webhooks 설정** (파일 변경 알림)
5. **파일 변경 감지 로직** (filesListFolderContinue)
6. **PDF 파일 필터링 로직** (.pdf만 허용)

**필요 패키지**:
```bash
npm install dropbox
npm install -D @types/dropbox
npm install node-cron  # 주기적 동기화용
```

**환경 변수**:
```
DROPBOX_ACCESS_TOKEN=your_dropbox_access_token
DROPBOX_ROOT_PATH=/교재자료
DROPBOX_WEBHOOK_SECRET=your_webhook_secret
NEXT_PUBLIC_APP_URL=https://your-domain.vercel.app
```

**구현 파일**:
- `lib/dropbox/dropboxService.ts` - Dropbox API 래퍼
- `lib/dropbox/dropboxSync.ts` - ⭐ 동기화 로직 (핵심)
- `lib/dropbox/pdfFilter.ts` - ⭐ PDF 필터링 유틸
- `app/api/dropbox/list/route.ts` - 파일 목록 API
- `app/api/dropbox/download/route.ts` - 파일 다운로드 API
- `app/api/dropbox/webhook/route.ts` - ⭐ 웹훅 수신 API
- `app/api/dropbox/sync/route.ts` - ⭐ 수동 동기화 트리거
- `app/api/cron/sync-dropbox/route.ts` - ⭐ 주기적 동기화 (5분마다)

**동기화 로직 설명**:

#### A. 초기 동기화 (Full Scan)
```typescript
// 1. Dropbox에서 모든 파일 목록 가져오기
const files = await dropbox.filesListFolder({ path: ROOT_PATH, recursive: true });

// 2. PDF 파일만 필터링
const pdfFiles = files.entries.filter(entry => 
  entry['.tag'] === 'file' && 
  entry.path_lower.endsWith('.pdf')
);

// 3. Supabase에 저장 (upsert)
for (const file of pdfFiles) {
  await supabase.from('files').upsert({
    dropbox_path: file.path_lower,
    dropbox_file_id: file.id,
    dropbox_rev: file.rev,
    name: file.name,
    file_size: file.size,
    last_modified: file.server_modified
  });
}

// 4. 커서 저장 (다음 변경 감지용)
await supabase.from('dropbox_cursor').upsert({
  cursor_value: files.cursor
});
```

#### B. 증분 동기화 (Incremental Sync)
```typescript
// 1. 마지막 커서 가져오기
const { cursor_value } = await supabase
  .from('dropbox_cursor')
  .select('cursor_value')
  .single();

// 2. 변경사항 감지
const changes = await dropbox.filesListFolderContinue({ cursor: cursor_value });

// 3. 변경사항 처리
for (const entry of changes.entries) {
  if (entry['.tag'] === 'file' && entry.path_lower.endsWith('.pdf')) {
    // 신규 또는 수정된 파일
    await supabase.from('files').upsert({...});
    await supabase.from('dropbox_sync_log').insert({
      sync_type: 'modify',
      dropbox_path: entry.path_lower,
      status: 'success'
    });
  } else if (entry['.tag'] === 'deleted') {
    // 삭제된 파일
    await supabase.from('files')
      .update({ is_active: false })
      .eq('dropbox_path', entry.path_lower);
    await supabase.from('dropbox_sync_log').insert({
      sync_type: 'delete',
      dropbox_path: entry.path_lower,
      status: 'success'
    });
  }
}

// 4. 새 커서 저장
await supabase.from('dropbox_cursor').update({
  cursor_value: changes.cursor
});
```

#### C. Webhook 수신 (실시간)
```typescript
// Dropbox에서 변경 알림 수신 → 즉시 증분 동기화 실행
export async function POST(request: Request) {
  const signature = request.headers.get('X-Dropbox-Signature');
  // 서명 검증...
  
  // 변경사항 있음 → 동기화 트리거
  await triggerIncrementalSync();
  
  return new Response('OK', { status: 200 });
}
```

**완료 조건**:
- ✅ Dropbox API 인증 완료
- ✅ 파일/폴더 목록 조회 기능
- ✅ 파일 다운로드 링크 생성 기능
- ✅ **PDF 파일만 필터링** (.pdf 확장자)
- ✅ **초기 전체 동기화 기능**
- ✅ **증분 동기화 기능** (변경사항만)
- ✅ **Webhook 수신 및 처리**
- ✅ **5분마다 자동 동기화** (cron)
- ✅ **동기화 로그 기록**

---

### Task 5: 로컬-드롭박스 연동 및 트리 뷰 (좌측 패널 우선 구현) ⭐ 핵심
**목표**: 드롭박스와 동기화된 PDF 파일 구조를 트리 뷰로 표시 + 교재별 클릭수 표시

**작업 내용**:
1. 파일 구조 트리 컴포넌트 생성
2. 드롭박스 폴더 계층 구조 파싱 (**PDF만**)
3. 재귀적 트리 렌더링
4. 폴더 열기/닫기 상태 관리
5. **실시간 리프레시** (Supabase Realtime 구독)
6. **PDF 파일만 필터링하여 표시**
7. **교재별 클릭수 표시** (교재명 옆에 뱃지로 표시)

**파일 구조** (PDF만 표시 + 클릭수 표시):
```
📚 중학영어 (클릭수: 1,245) 🔥         ← 교재별 총 클릭수 표시
  ├─ 📁 1학년/
  │   ├─ 📁 문법/
  │   │   ├─ 📄 현재시제.pdf (35)      ← 개별 파일 클릭수
  │   │   └─ 📄 과거시제.pdf (42)
  │   └─ 📁 독해/
  │       └─ 📄 지문1.pdf (18)
  └─ 📁 2학년/
      └─ 📄 종합문제.pdf (28)

📚 고등영어 (클릭수: 856)
  └─ 📁 수능대비/
      └─ 📄 모의고사.pdf (156)

📚 초등영어 (클릭수: 423)
  └─ ...

❌ 표시 안 됨: .docx, .hwp, .txt, 이미지 파일 등

💡 클릭수 많은 순서대로 교재 정렬 가능 (토글 옵션)
```

**구현 파일**:
- `components/sidebar/FileTree.tsx` - 트리 뷰 컴포넌트
- `components/sidebar/FileTreeItem.tsx` - 개별 아이템 (클릭수 뱃지 포함)
- `components/sidebar/TextbookHeader.tsx` - ⭐ 교재 헤더 (클릭수 표시)
- `components/sidebar/SyncStatus.tsx` - ⭐ 동기화 상태 표시
- `components/sidebar/SortToggle.tsx` - ⭐ 정렬 옵션 (이름순/클릭수순)
- `hooks/useDropboxFiles.ts` - 드롭박스 파일 로딩 훅
- `hooks/useRealtimeSync.ts` - ⭐ 실시간 동기화 훅
- `hooks/useTextbookStats.ts` - ⭐ 교재별 통계 훅

**실시간 업데이트 로직**:
```typescript
// Supabase Realtime으로 파일 변경 감지
const channel = supabase
  .channel('files_changes')
  .on(
    'postgres_changes',
    {
      event: '*',  // INSERT, UPDATE, DELETE
      schema: 'public',
      table: 'files',
      filter: 'is_active=eq.true'  // 활성 파일만
    },
    (payload) => {
      // 파일 목록 리프레시
      refreshFileTree();
    }
  )
  .subscribe();
```

**PDF 필터링 + 클릭수 조회 로직**:
```typescript
// 1. 교재별 총 클릭수 계산 (좌측 패널용)
const { data: textbooksWithClicks } = await supabase
  .from('textbooks')
  .select(`
    *,
    chapters (
      id,
      files (
        id,
        name,
        click_count
      )
    )
  `)
  .eq('chapters.files.is_active', true)
  .eq('chapters.files.file_type', 'pdf');

// 2. 교재별 총 클릭수 집계
const textbooksStats = textbooksWithClicks.map(textbook => ({
  ...textbook,
  totalClicks: textbook.chapters
    .flatMap(ch => ch.files)
    .reduce((sum, file) => sum + file.click_count, 0)
}));

// 3. 클릭수 순으로 정렬 (옵션)
const sortedTextbooks = textbooksStats.sort(
  (a, b) => b.totalClicks - a.totalClicks
);

// 4. 개별 파일 목록 (클릭수 포함)
const { data: files } = await supabase
  .from('files')
  .select('*, click_count')
  .eq('is_active', true)
  .eq('file_type', 'pdf')
  .order('name');
```

**완료 조건**:
- ✅ 드롭박스 파일 구조 로딩
- ✅ **PDF 파일만 필터링하여 표시** (.pdf만)
- ✅ 계층적 트리 뷰 표시
- ✅ PDF 파일 클릭 시 중앙 패널에 표시
- ✅ **교재별 총 클릭수 표시** (교재명 옆에 뱃지)
- ✅ **개별 파일 클릭수 표시** (파일명 옆에 작게)
- ✅ **정렬 옵션**: 이름순 / 클릭수 많은 순
- ✅ **실시간 파일 추가/삭제 반영** (Supabase Realtime)
- ✅ **실시간 클릭수 업데이트** (누군가 클릭 시 즉시 반영)
- ✅ **동기화 상태 표시** (마지막 동기화 시간)
- ✅ **수동 동기화 버튼**

---

---

### Task 4-1: Dropbox Webhook 설정 (추가 작업) ⭐ 핵심
**목표**: Dropbox에서 파일 변경 시 실시간 알림 수신

**작업 내용**:
1. Dropbox App Console에서 Webhook URL 등록
   - Webhook URL: `https://your-domain.vercel.app/api/dropbox/webhook`
2. Webhook 서명 검증 로직 구현
3. 웹훅 수신 시 동기화 트리거

**Dropbox App 설정**:
```
1. App Console → Your App → Webhooks 탭
2. Webhook URIs 추가: https://your-domain.vercel.app/api/dropbox/webhook
3. 초기 검증 요청 처리 (GET 요청 challenge 응답)
```

**웹훅 검증 로직**:
```typescript
import crypto from 'crypto';

function verifyWebhookSignature(signature: string, body: string): boolean {
  const hmac = crypto
    .createHmac('sha256', process.env.DROPBOX_WEBHOOK_SECRET!)
    .update(body)
    .digest('hex');
  
  return crypto.timingSafeEqual(
    Buffer.from(signature),
    Buffer.from(hmac)
  );
}
```

**완료 조건**:
- ✅ Webhook URL 등록
- ✅ 초기 검증 (GET challenge) 통과
- ✅ POST 웹훅 수신 및 서명 검증
- ✅ 웹훅 수신 시 자동 동기화 실행

---

## 📦 Phase 2: 메인 페이지 완성

### Task 6: 3단 레이아웃 구조 구현
**목표**: 메인 페이지 레이아웃 구조 완성 (A4 PDF 최적화)

**작업 내용**:
- 반응형 3단 레이아웃 (좌측: 280px, 중앙: flex-1 max-900px, 우측: 280px)
- PDF 중앙 정렬 (700-800px 표시)
- 모바일에서는 탭/드로어 형태로 전환

**레이아웃 비율**:
```
데스크톱 (1920px 기준):
┌─────────┬──────────────────────┬─────────┐
│  좌측    │       중앙 (PDF)      │  우측    │
│  280px  │    1360px (flex-1)   │  280px  │
│  14.6%  │       70.8%          │  14.6%  │
└─────────┴──────────────────────┴─────────┘

PDF 실제 표시: 700-800px (A4 최적 크기)
```

**구현 파일**:
- `app/page.tsx` - 메인 페이지
- `components/layout/ThreeColumnLayout.tsx` - 레이아웃 컴포넌트

**완료 조건**:
- ✅ 데스크톱 3단 레이아웃 (280px-flex-280px)
- ✅ 중앙 패널 max-width: 900px (PDF 최적화)
- ✅ 모바일 반응형 처리 (드로어)
- ✅ 각 패널 스크롤 독립성
- ✅ PDF 중앙 정렬

---

### Task 7: 좌측 패널 - 검색 및 정렬 기능
**목표**: 교재명으로 검색하여 필터링 + 클릭수 기반 정렬

**작업 내용**:
- 검색 입력창 (Command 컴포넌트 활용)
- 실시간 검색 필터링
- 검색 결과 하이라이팅
- **정렬 토글 버튼** (이름순 ↔ 클릭수순)
- **클릭수 많은 교재 강조 표시** (Top 3 하이라이트)

**구현 파일**:
- `components/sidebar/SearchBar.tsx`
- `components/sidebar/SortToggle.tsx` - ⭐ 정렬 토글
- `hooks/useSearch.ts`

**완료 조건**:
- ✅ 교재명 검색 기능
- ✅ 파일명 검색 기능 (단원/그룹/유형 포함)
- ✅ 검색 결과 즉시 반영
- ✅ 검색어 없을 시 전체 표시
- ✅ **이름순 정렬** (기본)
- ✅ **클릭수순 정렬** (인기순)
- ✅ **정렬 상태 유지** (로컬 스토리지)

---

### Task 8: 좌측 패널 - 교재 요청 기능
**목표**: 검색해도 없는 교재 요청 입력

**작업 내용**:
- 교재 요청 다이얼로그/폼
- Supabase에 요청 저장
- 중복 요청 카운트 증가

**구현 파일**:
- `components/sidebar/RequestTextbookDialog.tsx`
- `app/api/requests/route.ts`

**완료 조건**:
- ✅ 요청 폼 UI
- ✅ Supabase 저장
- ✅ 중복 요청 처리

---

### Task 9: 중앙 패널 - PDF 뷰어
**목표**: PDF 파일 미리보기 기능

**작업 내용**:
- PDF 렌더링 라이브러리 통합
- 페이지 네비게이션
- 확대/축소 기능

**필요 패키지**:
```bash
npm install react-pdf pdfjs-dist
npm install -D @types/react-pdf
```

**구현 파일**:
- `components/viewer/PDFViewer.tsx`
- `components/viewer/PDFControls.tsx`

**완료 조건**:
- ✅ PDF 렌더링
- ✅ 페이지 이동
- ✅ 확대/축소/전체화면

---

### Task 10: 우측 패널 - 최근 조회 자료 표시
**목표**: 최근에 클릭된 파일 목록 표시 (사용 순위는 좌측 패널에 통합)

**작업 내용**:
- Supabase에서 최근 클릭된 파일 조회 (시간 기준)
- 실시간 업데이트
- 썸네일 또는 아이콘 표시

**구현 파일**:
- `components/sidebar-right/RecentFiles.tsx` (이름 변경)
- `hooks/useRecentFiles.ts`

**완료 조건**:
- ✅ 최근 클릭 기준 정렬 (최신 순)
- ✅ Top 10 표시
- ✅ 자동 갱신
- ✅ 클릭 시 해당 파일로 이동

**참고**: 교재별 클릭수 순위는 좌측 패널에 통합되어 표시됨

---

### Task 11: 우측 패널 - 요청 순위 표시
**목표**: 요청 많은 교재 표시

**작업 내용**:
- Supabase에서 요청수 많은 순으로 조회
- 요청 목록 UI

**구현 파일**:
- `components/sidebar-right/RequestedTextbooks.tsx`

**완료 조건**:
- ✅ 요청수 기반 정렬
- ✅ Top 5 표시

---

### Task 12: 우측 패널 - 공지사항
**목표**: 활성화된 공지사항 표시

**작업 내용**:
- Supabase에서 공지사항 조회
- 최신순 표시
- 접기/펼치기 기능

**구현 파일**:
- `components/sidebar-right/Notices.tsx`

**완료 조건**:
- ✅ 공지사항 목록
- ✅ 최신 3개 표시

---

### Task 13: 클릭 추적 시스템
**목표**: 파일 클릭 시 로그 기록

**작업 내용**:
- 파일 클릭 이벤트 리스너
- Supabase에 클릭 로그 저장
- IP 주소 수집 (익명화)
- 클릭수 증가

**구현 파일**:
- `lib/analytics/trackClick.ts`
- `app/api/track/route.ts`

**완료 조건**:
- ✅ 클릭 이벤트 캡처
- ✅ Supabase 기록
- ✅ 클릭수 자동 증가

---

## 🔐 Phase 3: 관리자 페이지

### Task 14: 관리자 인증
**목표**: 관리자 로그인 시스템

**작업 내용**:
- Supabase Auth 연동
- 관리자 권한 체크
- Protected Routes

**구현 파일**:
- `app/admin/login/page.tsx`
- `middleware.ts`

**완료 조건**:
- ✅ 로그인 페이지
- ✅ 인증 미들웨어
- ✅ 권한 검증

---

### Task 15: 관리자 - 교재 목록 관리
**목표**: 클릭수 순 교재 목록 표시 및 상세 통계

**작업 내용**:
- 교재별 총 클릭수 통계
- 교재 내 파일별 클릭수 상세
- 정렬/필터링
- 그래프 시각화 (일별/주별/월별)
- 교재별 추세 분석

**구현 파일**:
- `app/admin/textbooks/page.tsx`
- `components/admin/TextbookStats.tsx`
- `components/admin/TextbookDetailStats.tsx` - ⭐ 교재 상세 통계

**완료 조건**:
- ✅ 교재 통계 테이블 (총 클릭수)
- ✅ 클릭수 그래프 (시간대별)
- ✅ 교재별 상세 뷰 (파일별 클릭수)
- ✅ 교재 추세 분석 (증가/감소 추세)

---

### Task 16: 관리자 - 요청 교재 관리
**목표**: 요청 많은 교재 관리

**작업 내용**:
- 요청 목록 표시
- 요청 승인/거부/완료 처리
- 요청자 정보

**구현 파일**:
- `app/admin/requests/page.tsx`

**완료 조건**:
- ✅ 요청 목록 테이블
- ✅ 상태 관리

---

### Task 17: 관리자 - 공지사항 CRUD
**목표**: 공지사항 생성/수정/삭제

**작업 내용**:
- 공지사항 리스트
- 생성/수정 폼
- 활성화/비활성화 토글

**구현 파일**:
- `app/admin/notices/page.tsx`
- `components/admin/NoticeForm.tsx`

**완료 조건**:
- ✅ CRUD 기능
- ✅ 활성화 관리

---

### Task 18: 관리자 - 사용자 통계 대시보드
**목표**: 종합 통계 대시보드

**작업 내용**:
- 시간대별 접속 그래프
- 일일/주간/월간 통계
- 인기 교재 TOP 10
- 요청 교재 TOP 10

**필요 패키지**:
```bash
npm install recharts
```

**구현 파일**:
- `app/admin/dashboard/page.tsx`
- `components/admin/AnalyticsDashboard.tsx`

**완료 조건**:
- ✅ 시간대별 접속 그래프
- ✅ 주요 지표 카드
- ✅ 인기/요청 순위

---

## 🎨 Phase 4: 디자인 & 배포

### Task 19: UI/UX 개선
**목표**: Vercel 스타일의 전문적인 디자인 적용

**작업 내용**:
- 다크 모드 지원
- 애니메이션 효과
- 로딩 스켈레톤
- 에러 처리 UI
- 반응형 최적화

**완료 조건**:
- ✅ 일관된 디자인 시스템
- ✅ 다크/라이트 모드
- ✅ 부드러운 전환 효과

---

### Task 20: Vercel 배포
**목표**: 프로덕션 배포

**작업 내용**:
1. GitHub 레포지토리 연결
2. Vercel 프로젝트 생성
3. 환경 변수 설정
4. 커스텀 도메인 연결 (선택)
5. 성능 최적화

**환경 변수 체크리스트**:
- ✅ NEXT_PUBLIC_SUPABASE_URL
- ✅ NEXT_PUBLIC_SUPABASE_ANON_KEY
- ✅ SUPABASE_SERVICE_ROLE_KEY
- ✅ DROPBOX_ACCESS_TOKEN
- ✅ DROPBOX_ROOT_PATH

**완료 조건**:
- ✅ 프로덕션 배포
- ✅ HTTPS 적용
- ✅ 도메인 연결

---

## 📁 프로젝트 구조 (최종)

```
eng-lib/
├── app/
│   ├── (main)/
│   │   ├── page.tsx                    # 메인 페이지 (3단 레이아웃)
│   │   └── layout.tsx
│   ├── admin/
│   │   ├── dashboard/
│   │   │   └── page.tsx               # 관리자 대시보드
│   │   ├── textbooks/
│   │   │   └── page.tsx               # 교재 관리
│   │   ├── requests/
│   │   │   └── page.tsx               # 요청 관리
│   │   ├── notices/
│   │   │   └── page.tsx               # 공지사항 관리
│   │   ├── login/
│   │   │   └── page.tsx               # 로그인
│   │   └── layout.tsx
│   ├── api/
│   │   ├── dropbox/
│   │   │   ├── list/route.ts          # 파일 목록
│   │   │   ├── download/route.ts      # 파일 다운로드
│   │   │   ├── webhook/route.ts       # ⭐ 웹훅 수신
│   │   │   └── sync/route.ts          # ⭐ 수동 동기화
│   │   ├── cron/
│   │   │   └── sync-dropbox/route.ts  # ⭐ 주기적 동기화
│   │   ├── track/route.ts             # 클릭 추적
│   │   └── requests/route.ts          # 교재 요청
│   └── layout.tsx
├── components/
│   ├── layout/
│   │   ├── ThreeColumnLayout.tsx      # 3단 레이아웃 (280-flex-280)
│   │   ├── LeftSidebar.tsx            # 좌측 패널 (280px)
│   │   ├── PDFPanel.tsx               # 중앙 PDF (max-900px)
│   │   └── RightSidebar.tsx           # 우측 패널 (280px)
│   ├── sidebar/                       # 좌측 패널
│   │   ├── FileTree.tsx
│   │   ├── FileTreeItem.tsx
│   │   ├── TextbookHeader.tsx         # ⭐ 교재 헤더 (클릭수 표시)
│   │   ├── SearchBar.tsx
│   │   ├── SortToggle.tsx             # ⭐ 정렬 옵션
│   │   ├── SyncStatus.tsx             # ⭐ 동기화 상태
│   │   └── RequestTextbookDialog.tsx
│   ├── viewer/                        # 중앙 패널
│   │   ├── PDFViewer.tsx
│   │   └── PDFControls.tsx
│   ├── sidebar-right/                 # 우측 패널
│   │   ├── RecentFiles.tsx            # ⭐ 이름 변경 (최근 조회)
│   │   ├── RequestedTextbooks.tsx
│   │   └── Notices.tsx
│   ├── admin/                         # 관리자 컴포넌트
│   │   ├── TextbookStats.tsx
│   │   ├── NoticeForm.tsx
│   │   └── AnalyticsDashboard.tsx
│   └── ui/                            # shadcn/ui 컴포넌트
│       ├── button.tsx
│       ├── card.tsx
│       └── ...
├── lib/
│   ├── dropbox/
│   │   ├── dropboxService.ts          # Dropbox API 래퍼
│   │   ├── dropboxSync.ts             # ⭐ 동기화 핵심 로직
│   │   ├── pdfFilter.ts               # ⭐ PDF 필터링
│   │   └── webhookVerify.ts           # ⭐ 웹훅 서명 검증
│   ├── supabase/
│   │   ├── client.ts                  # Supabase 클라이언트
│   │   └── types.ts                   # 타입 정의
│   └── analytics/
│       └── trackClick.ts              # 분석 유틸
├── hooks/
│   ├── useDropboxFiles.ts
│   ├── useRealtimeSync.ts             # ⭐ 실시간 동기화
│   ├── useTextbookStats.ts            # ⭐ 교재별 통계
│   ├── useSearch.ts
│   └── useRecentFiles.ts              # ⭐ 이름 변경
├── types/
│   └── index.ts                       # 전역 타입
├── docs/
│   ├── 전체기획서.md
│   └── 개발계획서.md                   # 이 문서
├── .env.local                         # 환경 변수
├── .gitignore
├── next.config.js
├── package.json
├── tailwind.config.ts
├── tsconfig.json
└── README.md
```

---

## 🔄 개발 플로우

### 1단계: 환경 구축 (2-3일) ⭐ 수정됨
- Task 1, 2, 3 완료
- Task 4 완료 (Dropbox API + 동기화 + Webhook)
- Task 4-1 완료 (Webhook 설정)
- 모든 외부 서비스 연동 완료

### 2단계: 핵심 기능 (4-6일) ⭐ 수정됨
- Task 5 완료 (트리 뷰 + 실시간 동기화 + PDF 필터링)
- Task 6, 9 완료
- 기본적인 파일 브라우징 + PDF 뷰어 + 자동 동기화

### 3단계: 부가 기능 (2-3일)
- Task 7, 8, 10, 11, 12, 13 완료
- 검색, 요청, 순위, 추적 기능

### 4단계: 관리자 기능 (3-4일)
- Task 14, 15, 16, 17, 18 완료
- 전체 관리자 시스템

### 5단계: 마무리 (1-2일)
- Task 19, 20 완료
- 디자인 개선 및 배포

**총 예상 기간: 12-18일** (실시간 동기화 기능 추가로 2일 증가)

---

## 📊 성공 지표 (KPI)

### 사용자 측면
- 일 방문자 수
- 평균 체류 시간
- PDF 클릭 수
- 교재 요청 수

### 기술 측면
- 페이지 로딩 속도 < 2초
- PDF 렌더링 시간 < 3초
- 모바일 성능 점수 > 90
- SEO 점수 > 95

---

## 🚨 주의사항

### 보안
- ✅ Dropbox Access Token 절대 노출 금지
- ✅ Supabase Service Role Key 서버 사이드만 사용
- ✅ 관리자 페이지 인증 필수
- ✅ RLS(Row Level Security) 정책 적용

### 성능
- ✅ 이미지 최적화 (Next.js Image)
- ✅ 코드 스플리팅
- ✅ PDF 렌더링 최적화 (페이지네이션)
- ✅ Supabase 쿼리 최적화 (인덱스)
- ✅ **동기화 빈도 조절** (웹훅 + 5분 cron, 과도한 API 호출 방지)
- ✅ **PDF 필터링으로 불필요한 파일 제외** (DB 크기 최적화)

### 사용자 경험
- ✅ 로딩 상태 표시
- ✅ 에러 핸들링
- ✅ 접근성 (a11y) 고려
- ✅ 모바일 최적화

---

## 📚 참고 자료

- [Next.js 공식 문서](https://nextjs.org/docs)
- [Supabase 공식 문서](https://supabase.com/docs)
- [shadcn/ui 문서](https://ui.shadcn.com/)
- [Dropbox API 문서](https://www.dropbox.com/developers/documentation)
- [Vercel 배포 가이드](https://vercel.com/docs)

---

## 🎯 1차 개발 목표 (우선순위) ⭐ 업데이트됨

기획서의 1차 목표 + 핵심 기능:

### ✅ 필수 완료 Task (핵심 기능 포함)
1. **Task 1** - 프로젝트 초기화 ⭐⭐⭐
2. **Task 2** - Supabase 설정 (9개 테이블) ⭐⭐⭐
3. **Task 3** - shadcn/ui 설정 ⭐⭐⭐
4. **Task 4** - Dropbox API 연동 + 실시간 동기화 + PDF 필터링 ⭐⭐⭐⭐⭐ **핵심!**
5. **Task 4-1** - Dropbox Webhook 설정 ⭐⭐⭐⭐ **핵심!**
6. **Task 5** - 로컬-드롭박스 연동 (좌측 패널) + 실시간 반영 ⭐⭐⭐⭐ **핵심!**

### 추가 권장 Task (빠른 프로토타입)
7. **Task 6** - 기본 레이아웃 ⭐⭐
8. **Task 9** - PDF 뷰어 (간단 버전) ⭐⭐

### 🔥 핵심 기능 체크리스트
- ✅ **로컬 폴더 → Dropbox 자동 동기화** (Dropbox Desktop App)
- ✅ **Dropbox API로 변경사항 실시간 감지** (Webhook + Cursor)
- ✅ **PDF 파일만 필터링** (.pdf 확장자)
- ✅ **데이터베이스 자동 업데이트** (신규/수정/삭제 파일)
- ✅ **프론트엔드 실시간 반영** (Supabase Realtime)
- ✅ **주기적 백업 동기화** (5분마다 cron)
- ✅ **동기화 상태 표시** (마지막 동기화 시간, 성공/실패)
- ✅ **좌측 패널에 교재별 클릭수 표시** (교재명 옆 뱃지)
- ✅ **클릭수 기반 정렬** (이름순 ↔ 인기순 토글)
- ✅ **실시간 클릭수 업데이트** (누군가 클릭 시 즉시 반영)

이 8개 Task만 완료해도:
- ✅ **로컬에서 파일 추가/삭제 → 웹사이트 자동 반영**
- ✅ **PDF 자료실 브라우징**
- ✅ **PDF 미리보기**

기능이 완벽하게 작동합니다!

---

---

## 📖 핵심 기능 상세 설명

### 🔄 실시간 동기화 플로우

```
로컬 폴더 (D:\교재\)
    ↓ (Dropbox Desktop App 자동 동기화)
Dropbox Cloud
    ↓ (Webhook 알림 또는 5분 cron)
Next.js API (변경 감지)
    ↓ (filesListFolderContinue)
변경사항 처리 (PDF만 필터링)
    ↓ (Supabase INSERT/UPDATE/DELETE)
PostgreSQL 데이터베이스
    ↓ (Realtime 구독)
프론트엔드 자동 업데이트
```

### 🎯 시나리오별 동작

#### 시나리오 1: 새로운 PDF 파일 추가
```
1. 사용자가 로컬 폴더에 "신규교재.pdf" 추가
2. Dropbox Desktop App이 자동으로 클라우드에 업로드
3. Dropbox가 Webhook 발송 → Next.js /api/dropbox/webhook
4. 서버가 변경사항 감지 (filesListFolderContinue)
5. "신규교재.pdf"를 Supabase files 테이블에 INSERT
6. 프론트엔드가 Realtime으로 감지 → 좌측 트리에 즉시 표시
```

#### 시나리오 2: PDF 파일 삭제
```
1. 사용자가 로컬에서 "구교재.pdf" 삭제
2. Dropbox 동기화 → 클라우드에서도 삭제
3. Webhook 발송
4. 서버가 삭제 감지
5. Supabase files 테이블에서 is_active = false 업데이트
6. 프론트엔드 트리에서 즉시 제거
```

#### 시나리오 3: PDF 파일 수정 (내용 변경)
```
1. 사용자가 로컬에서 "기존교재.pdf" 수정 후 저장
2. Dropbox 동기화 → rev (revision) 값 변경
3. Webhook 발송
4. 서버가 수정 감지 (rev 비교)
5. Supabase에서 file_size, last_modified, dropbox_rev 업데이트
6. 프론트엔드에서 자동 갱신 (사용자가 해당 파일을 보고 있다면 알림)
```

#### 시나리오 4: 다른 확장자 파일 추가 (.docx, .hwp 등)
```
1. 사용자가 로컬에 "문서.docx" 추가
2. Dropbox 동기화
3. Webhook 발송
4. 서버가 변경 감지 → PDF 아님 → 무시 (필터링)
5. 데이터베이스에 저장 안 됨
6. 프론트엔드에 표시 안 됨 ✅
```

### ⚙️ 동기화 전략

#### 1. Webhook 우선 (실시간)
- Dropbox 변경 시 즉시 알림 수신
- 가장 빠른 반영 (수초 이내)
- 메인 동기화 방식

#### 2. Cron 백업 (5분마다)
- Webhook 실패 대비 백업
- 네트워크 오류나 누락 방지
- Vercel Cron Jobs 사용

#### 3. 수동 동기화 버튼
- 관리자가 즉시 동기화 필요 시
- 초기 설정 후 전체 스캔
- UI에 "동기화" 버튼 제공

### 🔍 PDF 필터링 로직

```typescript
// lib/dropbox/pdfFilter.ts
export function isPdfFile(filename: string, mimeType?: string): boolean {
  // 1. 확장자 체크
  const ext = filename.toLowerCase().split('.').pop();
  if (ext !== 'pdf') return false;
  
  // 2. MIME 타입 체크 (옵션)
  if (mimeType && !mimeType.includes('pdf')) return false;
  
  // 3. 숨김 파일 제외
  if (filename.startsWith('.')) return false;
  
  // 4. 임시 파일 제외
  if (filename.includes('~$') || filename.endsWith('.tmp')) return false;
  
  return true;
}

// 사용 예시
const entries = await dropbox.filesListFolder({ path: '/교재' });
const pdfFiles = entries.entries.filter(entry => 
  entry['.tag'] === 'file' && isPdfFile(entry.name)
);
```

### 📊 동기화 모니터링

#### 관리자 대시보드에 표시할 정보:
- 마지막 동기화 시간
- 총 PDF 파일 수
- 최근 24시간 동기화 횟수
- 동기화 성공/실패 비율
- 최근 추가/삭제된 파일 목록
- 동기화 에러 로그

---

**작성일**: 2025-11-10
**버전**: 2.0 - 실시간 동기화 및 PDF 필터링 핵심 기능 추가

