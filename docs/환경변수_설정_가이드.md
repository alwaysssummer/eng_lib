# 🔐 환경 변수 설정 가이드

## 📋 개요

이 프로젝트는 Supabase와 Dropbox API를 사용하므로 환경 변수 설정이 필수입니다.

---

## 🚀 빠른 시작

### 1단계: 파일 복사

프로젝트 루트에서:

```bash
# Windows (PowerShell)
copy .env.local.example .env.local

# Mac/Linux
cp .env.local.example .env.local
```

### 2단계: 값 채우기

`.env.local` 파일을 열고 아래 가이드에 따라 값을 입력하세요.

---

## 🗄️ Supabase 환경 변수

### 필요한 값 (3개)

```env
NEXT_PUBLIC_SUPABASE_URL=https://xxxxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGci...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGci...
```

### 획득 방법

1. **Supabase 프로젝트 생성**
   - https://supabase.com 접속
   - "New Project" 클릭
   - 프로젝트 이름, 비밀번호, 리전(Seoul) 선택
   - 생성 완료까지 2-3분 대기

2. **API 키 확인**
   ```
   Supabase Dashboard
   → 좌측 메뉴: ⚙️ Project Settings
   → API 탭
   ```

3. **값 복사**
   - **Project URL** → `NEXT_PUBLIC_SUPABASE_URL`
   - **anon public** → `NEXT_PUBLIC_SUPABASE_ANON_KEY`
   - **service_role** → `SUPABASE_SERVICE_ROLE_KEY` ⚠️

### 예시

```env
# ✅ 올바른 예시
NEXT_PUBLIC_SUPABASE_URL=https://abcdefghijklmnop.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFiY2RlZmdoaWprbG1ub3AiLCJyb2xlIjoiYW5vbiIsImlhdCI6MTY5MDAwMDAwMCwiZXhwIjoyMDA1NTc2MDAwfQ.abcdefghijklmnopqrstuvwxyz1234567890
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFiY2RlZmdoaWprbG1ub3AiLCJyb2xlIjoic2VydmljZV9yb2xlIiwiaWF0IjoxNjkwMDAwMDAwLCJleHAiOjIwMDU1NzYwMDB9.1234567890abcdefghijklmnopqrstuvwxyz

# ❌ 잘못된 예시 (따옴표 사용 금지)
NEXT_PUBLIC_SUPABASE_URL="https://abcdefghijklmnop.supabase.co"

# ❌ 잘못된 예시 (공백 포함)
NEXT_PUBLIC_SUPABASE_URL = https://abcdefghijklmnop.supabase.co
```

---

## 📦 Dropbox 환경 변수

### 필요한 값 (3개)

```env
DROPBOX_ACCESS_TOKEN=sl.xxxxx
DROPBOX_ROOT_PATH=/교재자료
DROPBOX_WEBHOOK_SECRET=random-secret
```

### 획득 방법

#### 1. Dropbox App 생성

1. **Dropbox Developers 접속**
   - https://www.dropbox.com/developers/apps

2. **Create App 클릭**
   ```
   Choose an API: Scoped access
   Choose the type of access: Full Dropbox
   Name your app: eng-lib (또는 원하는 이름)
   ```

3. **App 생성 완료**

#### 2. Access Token 생성

1. **Permissions 탭**
   - 필요한 권한 체크:
     - ✅ `files.metadata.write`
     - ✅ `files.metadata.read`
     - ✅ `files.content.write`
     - ✅ `files.content.read`

2. **Settings 탭**
   ```
   Generated access token 섹션
   → "Generate" 버튼 클릭
   → Token 복사 (sl.xxxxxxxxxx)
   ```

3. **Webhook 설정 (선택)**
   ```
   Webhooks 섹션
   → Webhook URIs 입력: https://your-domain.vercel.app/api/dropbox/webhook
   ```

#### 3. 루트 경로 설정

드롭박스에서 교재가 저장된 폴더 경로:

```env
# 예시 1: 루트의 "교재자료" 폴더
DROPBOX_ROOT_PATH=/교재자료

# 예시 2: 하위 폴더
DROPBOX_ROOT_PATH=/문서/학교/교재

# 예시 3: 루트 전체
DROPBOX_ROOT_PATH=
```

#### 4. Webhook Secret 생성

```bash
# 랜덤 문자열 생성 (Mac/Linux)
openssl rand -hex 32

# 또는 직접 입력 (32자 이상 권장)
DROPBOX_WEBHOOK_SECRET=my-super-secret-webhook-string-12345678
```

### 예시

```env
# ✅ 올바른 예시
DROPBOX_ACCESS_TOKEN=sl.B1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ
DROPBOX_ROOT_PATH=/교재자료
DROPBOX_WEBHOOK_SECRET=a1b2c3d4e5f67890abcdef1234567890abcdef1234567890abcdef12345678

# ❌ 잘못된 예시 (짧은 Access Token)
DROPBOX_ACCESS_TOKEN=sl.abc123

# ❌ 잘못된 예시 (경로에 공백)
DROPBOX_ROOT_PATH=/교재 자료
```

---

## 🌐 애플리케이션 환경 변수

### 개발 환경

```env
NEXT_PUBLIC_APP_URL=http://localhost:3000
NODE_ENV=development
```

### 프로덕션 환경 (Vercel 배포 후)

```env
NEXT_PUBLIC_APP_URL=https://your-domain.vercel.app
NODE_ENV=production
```

---

## 📝 완전한 .env.local 예시

### 개발 환경 (로컬)

```env
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://abcdefghijklmnop.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFiY2RlZmdoaWprbG1ub3AiLCJyb2xlIjoiYW5vbiIsImlhdCI6MTY5MDAwMDAwMCwiZXhwIjoyMDA1NTc2MDAwfQ.abcdefghijklmnopqrstuvwxyz1234567890
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFiY2RlZmdoaWprbG1ub3AiLCJyb2xlIjoic2VydmljZV9yb2xlIiwiaWF0IjoxNjkwMDAwMDAwLCJleHAiOjIwMDU1NzYwMDB9.1234567890abcdefghijklmnopqrstuvwxyz

# Dropbox
DROPBOX_ACCESS_TOKEN=sl.B1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ
DROPBOX_ROOT_PATH=/교재자료
DROPBOX_WEBHOOK_SECRET=a1b2c3d4e5f67890abcdef1234567890abcdef1234567890abcdef12345678

# App
NEXT_PUBLIC_APP_URL=http://localhost:3000
NODE_ENV=development
```

---

## ✅ 검증 방법

### 1. 환경 변수 로드 확인

```bash
# 개발 서버 시작
npm run dev

# 브라우저 콘솔에서 확인
console.log(process.env.NEXT_PUBLIC_SUPABASE_URL)
```

### 2. Supabase 연결 테스트

브라우저에서 접속:
```
http://localhost:3000/test-db
```

**예상 결과**:
- ✅ 연결 성공!
- ✅ 9개의 테이블이 정상적으로 확인되었습니다.

### 3. Dropbox 연결 테스트 (Task 4 이후)

```typescript
// 테스트 코드
import { Dropbox } from 'dropbox';

const dbx = new Dropbox({ 
  accessToken: process.env.DROPBOX_ACCESS_TOKEN 
});

const result = await dbx.filesListFolder({ path: '' });
console.log('Dropbox 연결 성공:', result);
```

---

## 🚨 문제 해결

### 1. "Supabase URL is undefined" 오류

**원인**: 환경 변수가 로드되지 않음

**해결**:
```bash
# 1. .env.local 파일이 프로젝트 루트에 있는지 확인
ls -la .env.local

# 2. 파일 이름 확인 (정확히 .env.local)
# ❌ env.local (점 없음)
# ❌ .env.local.example (example 포함)
# ✅ .env.local (정확함)

# 3. 개발 서버 재시작
npm run dev
```

### 2. "Invalid API key" 오류

**원인**: API 키가 잘못됨

**해결**:
1. Supabase Dashboard에서 키 다시 복사
2. 키 앞뒤 공백 제거
3. 따옴표 제거 (큰따옴표, 작은따옴표 모두)
4. 전체 키가 복사되었는지 확인 (매우 긺)

### 3. "Dropbox unauthorized" 오류

**원인**: Access Token이 만료되었거나 잘못됨

**해결**:
1. Dropbox App Console에서 새 토큰 생성
2. Permissions 탭에서 필요한 권한 체크
3. "Submit" 버튼 클릭 (권한 변경 후)
4. Settings 탭에서 새 토큰 생성

### 4. 환경 변수가 브라우저에 노출됨

**원인**: `NEXT_PUBLIC_` 접두사가 붙으면 클라이언트에 노출됨

**해결**:
```env
# ✅ 클라이언트 노출 OK (공개 키)
NEXT_PUBLIC_SUPABASE_URL=...
NEXT_PUBLIC_SUPABASE_ANON_KEY=...

# ✅ 서버만 사용 (비밀 키)
SUPABASE_SERVICE_ROLE_KEY=...
DROPBOX_ACCESS_TOKEN=...
DROPBOX_WEBHOOK_SECRET=...

# ❌ 잘못된 예시 (비밀 키를 공개)
NEXT_PUBLIC_SUPABASE_SERVICE_ROLE_KEY=...  # 위험!
```

---

## 🔒 보안 주의사항

### ⚠️ 절대 하지 말 것

1. **Git에 커밋하지 마세요**
   ```bash
   # .gitignore에 포함됨 (확인)
   .env.local
   .env*.local
   ```

2. **공개 저장소에 업로드하지 마세요**
   - GitHub, GitLab 등에 `.env.local` 업로드 금지
   - 실수로 업로드한 경우 즉시 키 재발급

3. **스크린샷 공유 시 주의**
   - 환경 변수가 보이지 않도록
   - 모자이크 처리 필수

### ✅ 안전한 관리 방법

1. **프로덕션 환경**
   ```
   Vercel Dashboard → Settings → Environment Variables
   ```
   
2. **팀 협업**
   - `.env.local.example` 파일만 공유
   - 실제 키는 보안 도구 사용 (1Password, LastPass 등)

3. **키 재발급**
   - 정기적으로 키 재발급 (3-6개월)
   - 유출 의심 시 즉시 재발급

---

## 📚 참고 자료

- [Next.js 환경 변수 문서](https://nextjs.org/docs/app/building-your-application/configuring/environment-variables)
- [Supabase API 키 관리](https://supabase.com/docs/guides/api/api-keys)
- [Dropbox Access Token](https://www.dropbox.com/developers/documentation/http/documentation#authorization)

---

## ✅ 체크리스트

설정 완료 후 체크:

- [ ] `.env.local` 파일 생성
- [ ] Supabase URL 입력
- [ ] Supabase Anon Key 입력
- [ ] Supabase Service Role Key 입력
- [ ] Dropbox Access Token 입력
- [ ] Dropbox Root Path 설정
- [ ] Dropbox Webhook Secret 생성
- [ ] App URL 설정
- [ ] 개발 서버 재시작
- [ ] `/test-db` 페이지 테스트
- [ ] `.gitignore`에 `.env.local` 포함 확인

모두 완료되면 다음 단계로 진행하세요! 🎉

